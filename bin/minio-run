#!/usr/bin/env bash

REPO_ROOT="$(dirname $(dirname $(realpath ${BASH_SOURCE[0]:-${(%):-%x}})))"

docker run \
  --name s3-active-storage-minio \
  --rm \
  -d \
  -p 9000:9000 \
  -p 9001:9001 \
  -v "$REPO_ROOT/testdata:/data" \
  minio/minio \
    server \
    /data \
    --console-address ":9001"

# Make sure that the sample-data bucket is public
docker run \
  --rm \
  --link s3-active-storage-minio:minio \
  --entrypoint sh \
  minio/mc \
    -c "\
    set -e
    while ! curl http://minio:9000/minio/health/live; do sleep 1; done; \
    mc config host add minio http://minio:9000 minioadmin minioadmin; \
    mc policy set public minio/sample-data
    "

# Attach to the running container
exec docker attach --no-stdin s3-active-storage-minio
